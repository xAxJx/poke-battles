<% game = @battle.game %>
<% player_pokemon = @player_active&.pokemon %>
<% opponent_pokemon = @opponent_active&.pokemon %>
<% player_team_ids = @player_team_selected.map(&:id) %>
<% opponent_team_ids = @opponent_team_selected.map(&:id) %>
<% player_team = @player_team %>

<section class="landing battle-arena" data-landing-audio data-confirm-url="<%= asset_path('confirm.mp3') %>" data-ambient-url="<%= asset_path('Walen - Gameboy (freetouse.com).mp3') %>">
  <div class="landing-shell">
    <div class="landing-screen">
      <div class="screen-header">
        <p class="screen-title">Forest Arena</p>
        <div class="screen-meta">
          <span class="game-id">ID: <%= @battle.id %></span>
          <button class="sound-toggle" type="button" data-sound-toggle aria-pressed="false">
            <span class="sound-icon" aria-hidden="true">ðŸ”Š</span>
            <span class="sound-label" data-sound-label>Sound Off</span>
          </button>
        </div>
      </div>

      <div class="screen-body battle-screen">
        <div class="battle-columns">
          <div class="team-panel battle-panel">
            <h2 class="panel-title">Player</h2>
            <div class="battle-card">
              <div class="team-sprite battle-sprite">
                <% if player_pokemon&.picture.present? %>
                  <%= image_tag player_pokemon.picture, alt: player_pokemon.name %>
                <% else %>
                  <span class="sprite-placeholder">???</span>
                <% end %>
              </div>
              <div class="battle-info">
                <p class="team-name"><%= player_pokemon&.name&.capitalize || "Unknown" %></p>
                <div class="team-types">
                  <% if player_pokemon&.type1.present? %>
                    <span class="type-badge type-<%= player_pokemon.type1.to_s.parameterize %>"><%= player_pokemon.type1 %></span>
                  <% end %>
                  <% if player_pokemon&.type2.present? %>
                    <span class="type-badge type-<%= player_pokemon.type2.to_s.parameterize %>"><%= player_pokemon.type2 %></span>
                  <% end %>
                </div>
                <div class="hp-row">
                  <% current_hp = @player_active&.hp_current.to_i %>
                  <% max_hp = player_pokemon&.hp_max.to_i %>
                  <% max_hp = current_hp if max_hp <= 0 %>
                  <% hp_percent = max_hp.positive? ? ((current_hp.to_f / max_hp) * 100).clamp(0, 100) : 0 %>
                  <div class="hp-bar">
                    <div class="hp-fill" style="width: <%= hp_percent %>%"></div>
                  </div>
                  <span class="hp-text"><%= current_hp %>/<%= max_hp %></span>
                </div>
                <% if @player_active&.status.present? %>
                  <span class="status-chip"><%= @player_active.status %></span>
                <% end %>
              </div>
            </div>
          </div>

          <div class="team-panel battle-panel">
            <h2 class="panel-title">Opponent</h2>
            <div class="battle-card">
              <div class="team-sprite battle-sprite <%= @opponent_active ? "is-silhouette" : "" %>">
                <% if opponent_pokemon&.picture.present? %>
                  <%= image_tag opponent_pokemon.picture, alt: opponent_pokemon.name %>
                <% else %>
                  <span class="sprite-placeholder">???</span>
                <% end %>
              </div>
              <div class="battle-info">
                <p class="team-name"><%= opponent_pokemon&.name&.capitalize || "Unknown" %></p>
                <div class="team-types">
                  <% if opponent_pokemon&.type1.present? %>
                    <span class="type-badge type-<%= opponent_pokemon.type1.to_s.parameterize %>"><%= opponent_pokemon.type1 %></span>
                  <% end %>
                  <% if opponent_pokemon&.type2.present? %>
                    <span class="type-badge type-<%= opponent_pokemon.type2.to_s.parameterize %>"><%= opponent_pokemon.type2 %></span>
                  <% end %>
                </div>
                <div class="hp-row">
                  <% opponent_current_hp = @opponent_active&.hp_current.to_i %>
                  <% opponent_max_hp = opponent_pokemon&.hp_max.to_i %>
                  <% opponent_max_hp = opponent_current_hp if opponent_max_hp <= 0 %>
                  <% opponent_percent = opponent_max_hp.positive? ? ((opponent_current_hp.to_f / opponent_max_hp) * 100).clamp(0, 100) : 0 %>
                  <div class="hp-bar">
                    <div class="hp-fill" style="width: <%= opponent_percent %>%"></div>
                  </div>
                  <span class="hp-text"><%= opponent_current_hp %>/<%= opponent_max_hp %></span>
                </div>
                <% if @opponent_active&.status.present? %>
                  <span class="status-chip"><%= @opponent_active.status %></span>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="battle-log">
          <h2 class="panel-title">Battle Log</h2>
          <div class="battle-log-body">
            <% if @battle_actions.any? %>
              <ul class="battle-log-list">
                <% @battle_actions.each do |action| %>
                  <% action_selected_id = action.respond_to?(:id_selected_pokemons) ? action.id_selected_pokemons : action.selected_pokemon_id %>
                  <% side = if player_team_ids.include?(action_selected_id)
                              "PLAYER"
                            elsif opponent_team_ids.include?(action_selected_id)
                              "OPPONENT"
                            else
                              "UNKNOWN"
                            end %>
                  <% move = action.move %>
                  <% move_name = move&.name || Move.find_by(id: action.move_id)&.name || "move_id: #{action.move_id}" %>
                  <% power = if move && move.respond_to?(:move_power) && move.move_power.present?
                               move.move_power
                             elsif move && move.respond_to?(:power) && move.power.present?
                               move.power
                             else
                               10
                             end %>
                  <% pokemon_name = action.selected_pokemon&.pokemon&.name&.capitalize || "Unknown" %>
                  <li>[<%= side %>] <%= pokemon_name %> used <%= move_name %> (-<%= [power.to_i, 1].max %>)</li>
                <% end %>
              </ul>
            <% else %>
              <p class="empty-state">No actions yet.</p>
            <% end %>
          </div>
        </div>

        <div class="battle-command">
          <h2 class="panel-title">Command</h2>
          <% if @battle_over %>
            <p class="battle-helper"><%= @battle_result %></p>
          <% elsif !@opponent_ready %>
            <p class="battle-helper">Waiting for opponent</p>
          <% end %>
          <div class="command-box">
            <%= form_with scope: :battle_action, url: game_battle_actions_path(game, @battle), method: :post, local: true do %>
              <%= hidden_field_tag "battle_action[battle_id]", @battle.id %>
              <%= hidden_field_tag "battle_action[id_selected_pokemons]", @player_active&.id %>
              <div class="command-grid">
                <% 4.times do |index| %>
                  <% move = @player_moves[index] %>
                  <% if move %>
                    <% if !@battle_over && @opponent_ready && @player_active.present? %>
                      <button type="submit" class="command-button" name="battle_action[move_id]" value="<%= move.id %>"><%= move.name %></button>
                    <% else %>
                      <button type="button" class="command-button is-disabled" disabled><%= move.name %></button>
                    <% end %>
                  <% else %>
                    <button type="button" class="command-button is-disabled" disabled>â€”</button>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="secondary-actions">
            <%= link_to "Back to Game", game_path(game), class: "menu-link" %>
            <% if player_team %>
              <%= link_to "Edit Team", game_team_path(game, player_team), class: "menu-link" %>
            <% end %>
            <%= link_to "Home", root_path, class: "menu-link" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
